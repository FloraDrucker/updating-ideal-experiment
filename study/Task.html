{{ block title }}Task{{ endblock }}

{{ block content }}

<style>
    .hidden { display: none; }

    #attention-check {
        position: fixed;
        top: 40%;
        left: 50%;
        transform: translate(-50%, -50%);
        padding: 20px 30px;
        background: #fffae6;
        border: 2px solid #ffaa00;
        border-radius: 10px;
        font-size: 22px;
        font-weight: bold;
        text-align: center;
        z-index: 10000;
    }

    #attention-warning {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background: #ff4444;
        color: white;
        padding: 10px;
        font-size: 18px;
        font-weight: bold;
        text-align: center;
        z-index: 9999;
        display: none;
    }

    #stop-work-button {
        background: #d9534f;
        color: white;
        font-size: 18px;
        font-weight: bold;
        padding: 6px 12px;
        border-radius: 6px;
        margin-left: 20px;
    }

    #stop-work-button:hover {
        background: #c9302c;
    }

    #timer {
        font-size: 22px;
        font-weight: bold;
        margin-bottom: 10px;
    }
</style>


<div id="attention-warning"></div>

<div id="timer">
    Time remaining: <span id="time-remaining"></span>
    <button id="stop-work-button" type="button">Stop working</button>
</div>

<div id="work-container">
    <h4>Translate the letters using the dictionary:</h4>

    <div id="dictionary-box">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th>Letter</th>
                    <th>Number</th>
                </tr>
            </thead>
            <tbody id="dictionary-table"></tbody>
        </table>
    </div>

    <h4>Your word:</h4>
    <div id="word-box" style="font-size: 28px; font-weight: bold;"></div>

    <input type="number" id="answer-input" class="form-control" style="width:200px; font-size:20px;" />
    <button id="submit-answer" class="btn btn-primary" style="margin-top:10px;">Submit</button>

    <div style="margin-top:20px;">
        <strong>Performance:</strong> <span id="performance-counter">0</span><br>
        <strong>Mistakes:</strong> <span id="mistake-counter">0</span>
    </div>
</div>

<!-- Hidden attention check button -->
<div id="attention-check" class="hidden">
    Click here to continue
    <br><br>
    <button id="attention-button" class="btn btn-warning" style="font-size:20px;">I'm here</button>
</div>


{{ endblock }}

{{ block scripts }}
<script>

let dictData = null;
let wordData = null;

let performance = 0;
let mistakes = 0;

let workMode = true;
let attentionCheckInterval = 60;   // every minute during leisure
let lastAttentionCheckTime = null;

// Global countdown
let totalTime = js_vars.timeout_seconds;
let deadline = Date.now() + totalTime * 1000;

// Time tracking
let lastTick = Date.now();


// ------------------------------------------------------------
// ON LOAD: Request initial dictionary/word & periodic sync
// ------------------------------------------------------------
liveSend({init: true});


function renderDictAndWord() {
    // Render dictionary
    let table = document.getElementById('dictionary-table');
    table.innerHTML = "";
    for (const [letter, number] of Object.entries(dictData)) {
        let row = `<tr><td>${letter}</td><td>${number}</td></tr>`;
        table.insertAdjacentHTML('beforeend', row);
    }

    // Render word
    document.getElementById('word-box').innerText = wordData.join(' - ');
}


// SERVER â†’ CLIENT updates
function liveRecv(data) {

    if (data.dict && data.word) {
        dictData = data.dict;
        wordData = data.word;
        renderDictAndWord();
    }

    if ('performance' in data) performance = data.performance;
    document.getElementById('performance-counter').innerText = performance;

    if ('mistakes' in data) mistakes = data.mistakes;
    document.getElementById('mistake-counter').innerText = mistakes;

    if ('leisure_started' in data) {
        workMode = false;
        enterLeisureMode();
    }

    if ('attention_checks_failed' in data) {
        if (data.attention_checks_failed > 0) {
            showAttentionWarning();
        }
    }
}


// ------------------------------------------------------------
// SUBMIT ANSWER
// ------------------------------------------------------------
document.getElementById('submit-answer').onclick = function() {
    if (!workMode) return;

    let answer = parseInt(document.getElementById('answer-input').value);
    if (isNaN(answer)) return;

    let correct = wordData.map(l => dictData[l]).reduce((a,b)=>a+b, 0);

    if (answer === correct) {
        performance++;
        liveSend({performance: performance});
    } else {
        mistakes++;
        liveSend({mistakes: mistakes});
    }

    document.getElementById('answer-input').value = "";
};


// ------------------------------------------------------------
// STOP WORKING BUTTON
// ------------------------------------------------------------
document.getElementById('stop-work-button').onclick = function() {
    if (!workMode) return;
    workMode = false;

    liveSend({stop_working: true});
    enterLeisureMode();
};


// ------------------------------------------------------------
// ENTER LEISURE MODE
// ------------------------------------------------------------
function enterLeisureMode() {
    document.getElementById('work-container').style.display = "none";

    lastAttentionCheckTime = Math.floor((totalTime - (deadline - Date.now())/1000));

    // Immediately sync state
    liveSend({request_update: true});
}


// ------------------------------------------------------------
// ATTENTION CHECK
// ------------------------------------------------------------
function triggerAttentionCheck() {
    let box = document.getElementById('attention-check');
    box.classList.remove('hidden');

    let clicked = false;

    document.getElementById('attention-button').onclick = function() {
        clicked = true;
        box.classList.add('hidden');
        liveSend({attention_check_result: 'pass'});
    };

    setTimeout(function() {
        box.classList.add('hidden');

        if (!clicked) {
            liveSend({attention_check_result: 'fail'});
            showAttentionWarning();
        }
    }, 5000);
}


// ------------------------------------------------------------
// ATTENTION WARNING BANNER
// ------------------------------------------------------------
function showAttentionWarning() {
    let warn = document.getElementById('attention-warning');
    warn.innerText = "Missed attention check. If you miss one more, you will not receive payment for this non-work activity.";
    warn.style.display = "block";
    setTimeout(() => warn.style.display = "none", 3000);
}


// ------------------------------------------------------------
// GLOBAL TIMER TICK
// ------------------------------------------------------------
function tick() {
    let now = Date.now();
    let elapsed = (now - lastTick) / 1000;
    lastTick = now;

    let remaining = Math.max(0, Math.floor((deadline - now) / 1000));
    document.getElementById('time-remaining').innerText = remaining + "s";

    // Track task/leisure seconds
    if (workMode) {
        if (elapsed > 0) liveSend({add_task_seconds: Math.floor(elapsed)});
    } else {
        if (elapsed > 0) liveSend({add_leisure_seconds: Math.floor(elapsed)});
    }

    // Trigger attention checks EACH MINUTE OF LEISURE
    if (!workMode) {
        let timeSpent = totalTime - remaining;
        if (timeSpent - lastAttentionCheckTime >= attentionCheckInterval) {
            lastAttentionCheckTime = timeSpent;
            triggerAttentionCheck();
        }
    }

    // Automatic submit at end
    if (remaining <= 0) {
        document.getElementById('form').submit();
    }
}

setInterval(tick, 1000);

</script>
{{ endblock }}
