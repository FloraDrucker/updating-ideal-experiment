{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
  Survey Two.
{% endblock %}

{% block content %}
  <!-- INSTRUCTIONS -->
  <div id="instructions" style="font-size:1.2em; line-height:1.4; margin-bottom:2em;">
    <h5> This is a memory test. </h5>
    <p>In the following you will see a sequence of numbers. After a few seconds the numbers will disappear. After the numbers disappear, please type in the exact sequence of numbers that was presented to you.</p>
    <p>The sequences will get longer throughout the survey. After failing a sequence of the same length twice, you will proceed to the next round of encryption tasks.</p>
    <button id="start-btn" type="button" style="padding:0.5em 1em;">Start Test</button>
  </div>

  <!-- TASK FORM (always in DOM) -->
  <form id="digitspan-form" method="post">
    <input type="hidden" name="digitspan_max_level" id="digitspan_max_level" value="0">

    <div id="display-box" style="display:none; font-size:2em; height:2em; margin:1.5em 0;"></div>

    <div id="input-block" style="display:none; margin-bottom:1em;">
      <input id="response" type="text" autocomplete="off" style="font-size:1.5em; width:6em;">
      <button id="submit-btn" type="button" style="padding:0.5em 1em;">OK</button>
    </div>

    <button id="next-page-btn" type="submit" style="display:none; padding:0.5em 1em;">Next</button>
  </form>
{% endblock %}

{% block scripts %}
<script>
(function(){
  // keep sequences as STRINGS (preserves leading zeros)
  const sequences = [
    ['17','63'],['582','694'],['6439','7286'],['42731','75836'],
    ['619473','392487'],['5917428','4179386'],['58192647','38295174'],
    ['275862584','713942568']
  ];

  let level=0, stage=0, correctCount=0, phase='idle';

  const instr    = document.getElementById('instructions'),
        startBtn = document.getElementById('start-btn'),
        disp     = document.getElementById('display-box'),
        inputBlk = document.getElementById('input-block'),
        resp     = document.getElementById('response'),
        okBtn    = document.getElementById('submit-btn'),
        nextBtn  = document.getElementById('next-page-btn'),
        maxField = document.getElementById('digitspan_max_level');

  function saveState(){
    sessionStorage.setItem('ds_state', JSON.stringify({ level, stage, correctCount, phase }));
  }
  function clearState(){ sessionStorage.removeItem('ds_state'); }

  function showTrial(){
  inputBlk.style.display = 'none';
  const currentSequence = sequences[level][stage];
  disp.textContent = currentSequence;
  phase = 'show'; saveState();

  // calculate display time based on number of digits
  const displayTime = currentSequence.length * 1000;

  setTimeout(()=>{
    disp.textContent = '';
    inputBlk.style.display = 'block';
    resp.value = '';
    resp.focus();
    phase = 'input'; saveState();
  }, displayTime);
  }

  function finishTask(){
    // store 1-based max level reached
    maxField.value = (level + 1);
    inputBlk.style.display = 'none';
    nextBtn.style.display = 'inline-block';
    clearState();
  }

  // restore if page was refreshed mid-task
  (function restoreIfAny(){
    const st = sessionStorage.getItem('ds_state');
    if (!st) return;
    const s = JSON.parse(st);
    level = s.level ?? 0;
    stage = s.stage ?? 0;
    correctCount = s.correctCount ?? 0;
    phase = s.phase ?? 'show';

    instr.style.display = 'none';
    disp.style.display = 'block';

    if (phase === 'input') {
      disp.textContent = '';
      inputBlk.style.display = 'block';
      resp.value = '';
      resp.focus();
    } else {
      showTrial();
    }
  })();

  // Enter â†’ OK
  resp.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      e.preventDefault();
      okBtn.click();
    }
  });

  okBtn.addEventListener('click', ()=>{
    inputBlk.style.display = 'none';
    if (resp.value.trim() === sequences[level][stage]) {
      correctCount++;
    }
    stage++;

    if (stage < 2) {
      phase = 'show'; saveState();
      showTrial();
    } else {
      if (correctCount > 0 && level < sequences.length - 1) {
        level++; stage = 0; correctCount = 0;
        phase = 'show'; saveState();
        showTrial();
      } else {
        finishTask();
      }
    }
  });

  startBtn.addEventListener('click', ()=>{
    instr.style.display = 'none';
    // show the display box immediately
    disp.style.display = 'block';
    // fresh start
    level=0; stage=0; correctCount=0; phase='show'; saveState();
    showTrial();
  });
})();
</script>

{% endblock %}
