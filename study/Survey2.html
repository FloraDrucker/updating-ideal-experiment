{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
  Survey Two.
{% endblock %}

{% block content %}
  <!-- INSTRUCTIONS -->
  <div id="instructions" style="font-size:1.2em; line-height:1.4; margin-bottom:2em;">
    <h5> This is a memory test. </h5>
    <p>In the following you will see a sequence of numbers. After a few seconds the numbers will disappear.
       After the numbers disappear, please type in the exact sequence of numbers that was presented to you.</p>
    <p>The sequences will get longer throughout the survey. After failing a sequence of the same length twice,
       you will proceed to the next round of encryption tasks.</p>
    <p>Each sequence is shown for 0.5 seconds per digit (so e.g., a two-digit number is shown for one second).
       Then, you have 1.5 seconds per digit to type the sequence into the box (so e.g., you have three seconds to type in a two-digit number). </p>
    <button id="start-btn" type="button" style="padding:0.5em 1em;">Start Test</button>
  </div>

  <!-- TASK FORM (always in DOM) -->
  <form id="digitspan-form" method="post">
    <input type="hidden" name="digitspan_max_level" id="digitspan_max_level" value="0">

    <div id="display-box" style="display:none; font-size:2em; height:2em; margin:1.5em 0;"></div>

    <div id="input-block" style="display:none; margin-bottom:1em;">
      <input id="response" type="number" inputmode="numeric" pattern="[0-9]*"
             autocomplete="off" style="font-size:1.5em; width:6em;">
      <button id="submit-btn" type="button" style="padding:0.5em 1em;">OK</button>
    </div>

    <div id="end-message" style="display:none; font-size:1.2em; color:#000000; margin-top:1em;">
      <p><strong>The test has ended. Please click on the Next button to continue.</strong></p>
    </div>

    <button id="next-page-btn" type="submit" style="display:none; padding:0.5em 1em;">Next</button>
  </form>
{% endblock %}

{% block scripts %}
<script>

(function(){
  // keep sequences as STRINGS (preserves leading zeros)
  const sequences = [
    ['17','63'],['582','694'],['6439','7286'],['42731','75836'],
    ['619473','392487'],['5917428','4179386'],['58192647','38295174'],
    ['275862584','713942568']
  ];

  let inputTimer = null;

  function startInputTimer() {
    clearInputTimer();  // â­ ensure no leftover timers
    const currentSequence = sequences[level][stage];
    const INPUT_TIME_LIMIT = currentSequence.length * 1500; // 1.5 sec per digit

    inputTimer = setTimeout(() => {
        forceSubmit();
    }, INPUT_TIME_LIMIT);
  }

  function clearInputTimer() {
    if (inputTimer !== null) {
        clearTimeout(inputTimer);
        inputTimer = null;
    }
  }

  function forceSubmit() {
    clearInputTimer();
    okBtn.click();
  }

  let level=0, stage=0, correctCount=0, phase='idle';

  const instr    = document.getElementById('instructions'),
        startBtn = document.getElementById('start-btn'),
        disp     = document.getElementById('display-box'),
        inputBlk = document.getElementById('input-block'),
        resp     = document.getElementById('response'),
        okBtn    = document.getElementById('submit-btn'),
        nextBtn  = document.getElementById('next-page-btn'),
        maxField = document.getElementById('digitspan_max_level');

  function saveState(){
    sessionStorage.setItem('ds_state', JSON.stringify({ level, stage, correctCount, phase }));
  }
  function clearState(){ sessionStorage.removeItem('ds_state'); }

  function showTrial(){
    inputBlk.style.display = 'none';
    const currentSequence = sequences[level][stage];
    disp.textContent = currentSequence;
    phase = 'show';
    saveState();

    const displayTime = currentSequence.length * 500;

    setTimeout(()=>{
        disp.textContent = '';
        inputBlk.style.display = 'block';
        resp.value = '';
        resp.focus();
        phase = 'input';
        saveState();

        startInputTimer();
    }, displayTime);
  }

  function finishTask(){
    maxField.value = (level + 1);

    inputBlk.style.display = 'none';
    disp.style.display = 'none';

    document.getElementById('end-message').style.display = 'block';
    nextBtn.style.display = 'inline-block';

    sessionStorage.setItem('digitspan_finished', '1');
    clearState();
  }

  // restore if page was refreshed mid-task
  (function restoreIfAny(){
    const finished = sessionStorage.getItem('digitspan_finished');
    if (finished === '1') {
        instr.style.display = 'none';
        disp.style.display = 'none';
        inputBlk.style.display = 'none';
        document.getElementById('end-message').style.display = 'block';
        nextBtn.style.display = 'inline-block';
        return;
    }

    const st = sessionStorage.getItem('ds_state');
    if (!st) return;

    const s = JSON.parse(st);
    level = s.level ?? 0;
    stage = s.stage ?? 0;
    correctCount = s.correctCount ?? 0;
    phase = s.phase ?? 'show';

    instr.style.display = 'none';
    disp.style.display = 'block';

    if (phase === 'input') {
        disp.textContent = '';
        inputBlk.style.display = 'block';
        resp.value = '';
        resp.focus();
        startInputTimer();
    } else {
        showTrial();
    }
  })();

  okBtn.addEventListener('click', ()=>{
    clearInputTimer();
    inputBlk.style.display = 'none';

    if (resp.value.trim() === sequences[level][stage]) {
      correctCount++;
    }
    stage++;

    if (stage < 2) {
      phase = 'show'; saveState();
      showTrial();
    } else {
      if (correctCount > 0 && level < sequences.length - 1) {
        level++; stage = 0; correctCount = 0;
        phase = 'show'; saveState();
        showTrial();
      } else {
        finishTask();
      }
    }
  });

  startBtn.addEventListener('click', ()=>{
    instr.style.display = 'none';
    disp.style.display = 'block';
    level=0; stage=0; correctCount=0; phase='show';
    saveState();
    showTrial();
  });

  // Disable Enter
  document.addEventListener("keydown", function (e) {
    if (e.key === "Enter") {

      // allow Enter if OK button is focused
      if (document.activeElement === okBtn) {
          return;
      }

      // allow Enter if Next button is focused
      if (document.activeElement === nextBtn) {
          return;
      }

      // otherwise block Enter everywhere else
      e.preventDefault();
  }
});

})();
</script>
{% endblock %}
