{% extends "global/Page.html" %}
{% load otree static %}

{% block title %}
Survey Two.
{% endblock %}

{% block content %}

<style>
    /* Prevent selecting the shown sequence (helps reduce manual copying). */
    #display-box {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>

<!-- INSTRUCTIONS -->
<div id="instructions" style="font-size:1.2em; line-height:1.4; margin-bottom:2em;">
    <h5>This is a memory test.</h5>
    <p>In the following you will see a sequence of numbers. After a few seconds the numbers will disappear.
        After the numbers disappear, please <b>type in the exact sequence of numbers that was presented</b> to you.</p>
    <p>The <b>sequences will get longer</b> throughout the survey. After failing a sequence of the same length twice,
        you will proceed to the next round of encryption tasks.</p>
    <p>Each sequence is <b>shown for 0.5 seconds per digit</b> (so e.g., a two-digit number is shown for one second).
        Then, you have <b>1.5 seconds per digit to type the sequence</b> into the box (so e.g., you have three seconds to type in a two-digit number). Your answer will be <b>logged automatically</b> once the time has expired.</p>
    <p> Please note that to ensure that the memory test is done properly, <b>copy and paste is disabled</b> on the page.</p>
    <button id="start-btn" type="button" style="padding:0.5em 1em;">Start Test</button>
</div>

<!-- TASK FORM -->
<form id="digitspan-form" method="post">
    <input type="hidden" name="digitspan_max_level" id="digitspan_max_level" value="0">

    <div id="display-box" style="display:none; font-size:2em; height:2em; margin:1.5em 0;"></div>

    <div id="input-block" style="display:none; margin-bottom:1em;">
        <input id="response" type="number" inputmode="numeric" pattern="[0-9]*"
               autocomplete="off" style="font-size:1.5em; width:6em;">
    </div>

    <div id="end-message" style="display:none; font-size:1.2em; color:#000000; margin-top:1em;">
        <p><strong>The test has ended. Please click on the "Next" button to continue.</strong></p>
    </div>

    <button id="next-page-btn" type="submit" style="display:none; padding:0.5em 1em;">Next</button>
</form>

{% endblock %}

{% block scripts %}
<script>
(function () {
    function getRiskRows() {
        const table = document.getElementById('risk-table');
        if (!table) return [];
        const trs = Array.from(table.querySelectorAll('tbody tr'));

        // Each risk row should contain exactly 2 radio inputs (LHS and RHS)
        const rows = trs.map(tr => {
            const radios = Array.from(tr.querySelectorAll('input[type="radio"]'));
            return radios.length === 2 ? radios : null;
        }).filter(Boolean);

        return rows; // array of [lhsRadio, rhsRadio]
    }

    function setChecked(radio) {
        if (radio) radio.checked = true;
    }

    function enforceSingleSwitch(rows, clickedRowIndex, clickedSide) {
        // clickedSide: 0 = LHS, 1 = RHS
        for (let r = 0; r < rows.length; r++) {
            const lhs = rows[r][0];
            const rhs = rows[r][1];

            // Rule: rows ABOVE = RHS, rows BELOW = LHS
            if (r < clickedRowIndex) {
                setChecked(rhs);
            } else if (r > clickedRowIndex) {
                setChecked(lhs);
            } else {
                // clicked row: respect what they clicked
                if (clickedSide === 0) setChecked(lhs);
                else setChecked(rhs);
            }
        }
    }

    function normalizeFromExisting(rows) {
        // On reload/back, coerce to: top block RHS, bottom block LHS.
        // Use the first LHS encountered as the "switch" point; everything above it -> RHS, from it down -> LHS.
        const anyChecked = rows.some(([lhs, rhs]) => lhs.checked || rhs.checked);
        if (!anyChecked) return;

        const firstLHS = rows.findIndex(([lhs, rhs]) => lhs.checked);
        if (firstLHS === -1) {
            // No LHS selected -> make all RHS
            rows.forEach(([lhs, rhs]) => setChecked(rhs));
        } else {
            rows.forEach(([lhs, rhs], idx) => {
                if (idx < firstLHS) setChecked(rhs);
                else setChecked(lhs);
            });
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const rows = getRiskRows();
        if (!rows.length) return;

        normalizeFromExisting(rows);

        rows.forEach((pair, rowIndex) => {
            pair.forEach((radio, sideIndex) => {
                radio.addEventListener('change', () => {
                    enforceSingleSwitch(rows, rowIndex, sideIndex);
                });
            });
        });
    });
})();
</script>
{% endblock %}

